# atrogue/Makefile - classical-style Makefile
# This file is part of atrogue, a "Rogue-like game" created by Arne Thomassen;
# atrogue is basically released under certain versions of the GNU General
# Public License and WITHOUT ANY WARRANTY.
# Read the file COPYING for license details, README for game information.
# Copyright (C) 2001-2010 Arne Thomassen <arne@arne-thomassen.de>

# Part A. You might want to change the following settings;
# see atrogue/docu/config.html for documentation.

# text mode settings (0 = off, 1 = on)
OPTION_NCURSES = 1
OPTION_COLORS = 1
OPTION_TEXTMODEMOUSE = 0

# animation (milliseconds between steps; 0 means off)
OPTION_ANIMATION     = 0

# random number generator
OPTION_RNG           = /dev/urandom

# put your favourite C compiler here; mine is "gcc"
CC = gcc

# compiler flags
CFLAGS =


# Part B. Don't change any of the following!

CONFIG_DEMO      = 0
CONFIG_REMOTE    = 0
CONFIG_DEBUG     = 0
CONFIG_GRAPHICS  = 0

ATROGUE_VERSION = 0.3.0

# choose a sane optimization level and activate useful warnings for gcc:
ifeq ($(CC), gcc)
CFLAGS += -O2
ifeq ($(CONFIG_DEBUG), 1)
CFLAGS += -Wall -W -Wchar-subscripts -Wbad-function-cast -Wmissing-prototypes -Wtraditional -Wcast-align -Wshadow -Wwrite-strings -Waggregate-return -Winline -ggdb # -Wpointer-arith -Wundef -Wmissing-noreturn # -Wcast-qual -Wredundant-decls # -Wpadded -Wunreachable-code # -Wconversion # -pedantic
endif
endif

# add GTK flags
ifeq ($(CONFIG_GRAPHICS), 1)
CFLAGS += $(shell gtk-config --cflags)
endif

# object files
OBJS = main.o init.o object.o creature.o dungeon.o action.o message.o random.o stat.o stuff.o
ifneq ($(OPTION_ANIMATION), 0)
	OBJS += animation.o
endif
ifeq ($(CONFIG_REMOTE), 1)
	OBJS += remote.o
endif

build_binary: clean config atroguebin stripsyms msg

devel: clean config atroguebin

config:
	@echo "/* Auto-generated by atrogue/Makefile, do not edit */" >.config
	@echo "#define USING_CONFIGURE 0" >>.config
# configure script simulation...
	@echo "#define STDC_HEADERS 1" >>.config
	@echo "#define HAVE_ERRNO_H 1" >>.config
	@echo "#define HAVE_FCNTL_H 1" >>.config
	@echo "#define HAVE_MEMORY_H 1" >>.config
	@echo "#define HAVE_STDDEF_H 1" >>.config
	@echo "#define HAVE_STDLIB_H 1" >>.config
	@echo "#define HAVE_STRING_H 1" >>.config
	@echo "#define HAVE_STRINGS_H 1" >>.config
	@echo "#define HAVE_SYS_STAT_H 1" >>.config
	@echo "#define HAVE_SYS_TIME_H 1" >>.config
	@echo "#define HAVE_SYS_TYPES_H 1" >>.config
	@echo "#define HAVE_UNISTD_H 1" >>.config
	@echo "#define HAVE_NCURSES_H 1" >>.config
	@echo "#define HAVE_BCOPY 1" >>.config
	@echo "#define HAVE_BZERO 1" >>.config
	@echo "#define HAVE_GETTIMEOFDAY 1" >>.config
	@echo "#define HAVE_MEMCPY 1" >>.config
	@echo "#define HAVE_MEMSET 1" >>.config
	@echo "#define HAVE_SELECT 1" >>.config
	@echo "#define HAVE_STRCHR 1" >>.config
# ...and the real stuff
	@echo "#define ATROGUE_VERSION \"$(ATROGUE_VERSION)\"" >>.config
	@echo "#define CONFIG_GRAPHICS $(CONFIG_GRAPHICS)" >>.config
	@echo "#define OPTION_COLORS $(OPTION_COLORS)" >>.config
	@echo "#define OPTION_ANIMATION $(OPTION_ANIMATION)" >>.config
	@echo "#define OPTION_RNG \"$(OPTION_RNG)\"" >>.config
	@echo "#define OPTION_NCURSES $(OPTION_NCURSES)" >>.config
	@echo "#define OPTION_TEXTMODEMOUSE $(OPTION_TEXTMODEMOUSE)" >>.config
	@echo "#define CONFIG_DEMO $(CONFIG_DEMO)" >>.config
	@echo "#define CONFIG_REMOTE $(CONFIG_REMOTE)" >>.config
	@echo "#define CONFIG_DEBUG $(CONFIG_DEBUG)" >>.config

ifeq ($(CONFIG_GRAPHICS), 1)
LCLC = $(shell gtk-config --cflags --libs)
else
ifeq ($(OPTION_NCURSES), 1)
CLC = ncurses
else
CLC = curses
endif
LCLC = -l$(CLC)
endif

ifeq ($(CONFIG_GRAPHICS), 1)
%.o: %.c
	$(CC) $(CFLAGS) -c $*.c -o $@
# "else": the make system knows what to do itself...
endif

atroguebin: $(OBJS)
	$(CC) $(OBJS) $(LCLC) -o atrogue

msg:
	@echo "Compilation seems to be successful!"
#	@echo "(Don't care about any \"uninitialized\" warnings - they're wrong:-)"
	@echo "Now try to start the game with \"./atrogue\"."

stripsyms:
	-strip --strip-unneeded atrogue

report: config
	-@echo "Please include the following information in all your bug and"
	-@echo "problem reports:"
	-@echo "(Beginning of report info)"
	-@echo "atrogue version: $(ATROGUE_VERSION)"
	-@echo -n "Compiler: $(CC) "
	-@$(CC) --version
	-@echo "System:"
	-@uname -m -s -r -v -p
	-@echo "version of \"make\":"
	-@make --version
	-@echo "version of \"strip\":"
	-@strip --version
	-@echo "atrogue configuration file (\".config\"):"
	-@cat .config
	-@echo "(End of report info)"

clean:
	rm -f $(OBJS) .config

.PHONY: build_binary clean config devel msg report atroguebin stripsyms
